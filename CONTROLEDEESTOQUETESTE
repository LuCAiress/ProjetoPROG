
#include <stdlib.h>
#include <stdio.h>
#include<locale.h>
#include<string.h>
#include <conio.h>

struct cliente {
 int codigo; 
 char nomecli[50]; 
 char telefone [15]; 
 char sexo; 
 char cpf[11];
 };
struct produto{
	int cdgprod;
	char nome[50];
	float preco;
	int qtd;
};
struct compra_venda{
 int codigo_cv; 
 char nomecli[50];
 char nomevendedor[50]; 
 int produtovendido; 
 int qtd[]; 
 
 };
 char Validaresp() {
	
 char vresp;
 do {
 printf("\n==Você deseja criar este cadastro [S ou N]?" );
 vresp = getche();
 } while (vresp != 'S' && vresp != 'N');
 return vresp;
}
void entrada_compra (FILE * Arquivo, FILE *Arquivo1);
int main(){

 FILE * Arquivo;
 FILE * Arquivo1 = fopen("PRODUTOS.txt", "rb+");
 	int erro=0;
     char arqcv [] = {"COMPRA.txt"};
	 Arquivo = fopen(arqcv, "ab+");
  	 if (Arquivo == NULL) {
	 printf("\n>>>Arquivo %s não existe! Caso deseje prosseguir, tecle algo para criar um novo arquivo.<<<", arqcv);
 	getch();
	 if ((Arquivo = fopen(arqcv, "wb+")) == NULL) {
	 erro = 1;
 	printf("\n>>>ERRO! Impossível criar o arquivo %s!<<<", arqcv);
	 getch();
 }
 } 
 	if(erro==0){
 		entrada_compra(Arquivo, Arquivo1);
 		fclose (Arquivo);
        fclose (Arquivo1);
	 }	
 }
 
void entrada_compra (FILE * Arquivo, FILE *Arquivo1) {
 int retorno;
 struct compra_venda novo;
 struct produto est;
 char vresp;
 int qtd;
 do {
rewind(Arquivo1);
fread (&est, sizeof(est),1,Arquivo1); 
 printf("\n==Digite o código da compra (0 volta para o menu): ");
 scanf("%d", &novo.codigo_cv);
 if (novo.codigo_cv != 0) {
 printf("\n==Digite o nome do cliente: ");
 fflush(stdin);
 gets(novo.nomecli);
 printf("\n==Digite o nome do vendedor: " );
 gets(novo.nomevendedor);
 
 printf("\n==Digite o código do produto vendido: ");
 scanf("%d",&novo.produtovendido);
 fflush(stdin);
est.cdgprod=novo.produtovendido;
if (est.qtd==0){
    printf("\n>>>ERRO! Falta estoque do produto!<<<");
    return;
}
printf("\n==Digite a quantidade vendida: ");
 scanf("%d", &novo.qtd);
est.qtd=est.cdgprod-*novo.qtd;

 if(est.qtd<0){
    printf("\n>>>ERRO! Impossível vender mais que o estoque do produto!<<<");
 }
 fflush(stdin);
 
 vresp = Validaresp();
 if (vresp == 'S') {
 retorno = fwrite (&novo, sizeof(struct compra_venda) ,1,Arquivo);

 if (retorno == 1) {
 printf("\n>>>Compra cadastrada com sucesso!<<<");
 getch();
 }
 else {
 printf ("\n>>>ERRO: Não foi possível efetuar o cadastro!<<<");
 getch();
 }
 }
 }
 } while (novo.codigo_cv != 0);
}
